digraph HealthCallAgentDataflow {
    rankdir=LR;
    bgcolor=white;
    node [shape=box, style=filled, fontname="Arial", fontsize=10];
    edge [fontname="Arial", fontsize=9];
    nodesep=1.2;
    ranksep=2.0;

    // ============================================================================
    // LAYER 1: DATA SOURCE
    // ============================================================================
    subgraph cluster_datasource {
        label="LAYER 1: Data Source\n(Database)";
        style=filled;
        fillcolor="#E8F4F8";
        
        DB [label="Clinic Database\n\nCall Records:\n‚Ä¢ Conversation JSON\n  (patient ‚Üî AI agent)\n‚Ä¢ Custom API Calls\n  (EMR lookups, bookings)\n‚Ä¢ Timestamps\n‚Ä¢ Call Status", shape=cylinder, fillcolor="#4A90E2"];
    }

    // ============================================================================
    // LAYER 2: SCHEDULER & FILTERS
    // ============================================================================
    subgraph cluster_scheduler {
        label="LAYER 2: Daily Cronjob Scheduler\n(end of day: 11:59 PM)";
        style=filled;
        fillcolor="#FFF8E8";
        
        CRONJOB [label="Cronjob Trigger\n\nTime: Daily 23:59\nAction: Run analysis", shape=box, fillcolor="#FFD700"];
        
        FILTER [label="Filter Calls with Issues\n\nCriteria:\n‚Ä¢ Call purpose NOT achieved\n‚Ä¢ Errors in API calls\n‚Ä¢ Customer dissatisfaction\n‚Ä¢ System failures\n\n‚¨áÔ∏è Extract problematic calls only", shape=box, fillcolor="#FFA500"];
    }

    // ============================================================================
    // LAYER 3: BATCH PROCESSING
    // ============================================================================
    subgraph cluster_batch {
        label="LAYER 3: Batch Processing\n(Group of 10 calls)";
        style=filled;
        fillcolor="#F5F5F5";
        
        BATCH [label="Batch Generator\n\nGroup filtered calls:\n‚Ä¢ Batch Size: 10 calls\n‚Ä¢ Total calls filtered: N\n‚Ä¢ Batches created: ‚åàN/10‚åâ\n\nExample:\n165 filtered calls ‚Üí 17 batches", shape=box, fillcolor="#D3D3D3"];
        
        QUEUE [label="Queue Management\n\n‚úì Each batch queued\n‚úì Priority: FIFO\n‚úì Retry on failure\n‚úì Error tracking", shape=box, fillcolor="#A9A9A9"];
    }

    // ============================================================================
    // LAYER 4: AGENT WORKFLOW
    // ============================================================================
    
    // Agent 1
    subgraph cluster_agent1 {
        label="AGENT 1: Identify Call Purpose\n(AI-powered with Prompt)";
        style=filled;
        fillcolor="#FFF8E8";
        
        AGENT1 [label="Processes Batch of 10 Calls\n\nFor each call:\nPrompt: \"What was the patient\ntrying to achieve?\"\n\nüìå Output 1 (per call):\n‚Ä¢ Purpose: appointment_booking\n‚Ä¢ Confidence: high\n‚Ä¢ Summary: Details", shape=box, fillcolor="#FFD700"];
    }

    // Agent 2
    subgraph cluster_agent2 {
        label="AGENT 2: Analyze Failure Causes\n(AI-powered with Prompt)";
        style=filled;
        fillcolor="#FFE8F8";
        
        AGENT2A [label="Agent 2 Receives (for each call):\n‚Ä¢ Output 1: Purpose\n‚Ä¢ Full conversation JSON\n‚Ä¢ Custom API calls & responses\n\nAnalyzes BOTH factors:", shape=box, fillcolor="#FF9999"];
        
        AGENT2B [label="üè¢ BUSINESS/OPERATIONAL ISSUES:\n\n‚Ä¢ System downtime\n‚Ä¢ Database query failed\n‚Ä¢ EMR API timeout\n‚Ä¢ No available slots\n‚Ä¢ Policy restrictions\n‚Ä¢ Missing patient data", shape=box, fillcolor="#FFB3B3"];
        
        AGENT2C [label="ü§ñ AGENTIC WORKFLOW ISSUES:\n\n‚Ä¢ Agent misinterpretation\n‚Ä¢ Wrong API called\n‚Ä¢ Logic error in workflow\n‚Ä¢ Model hallucination\n‚Ä¢ Node failure/timeout\n‚Ä¢ Incorrect slot booking", shape=box, fillcolor="#FF6B6B"];
        
        AGENT2_OUT [label="‚ö†Ô∏è  Output 2 (per call):\n\nFailure Analysis:\n‚Ä¢ Operational issues: [...]  \n‚Ä¢ Agentic issues: [...]\n‚Ä¢ Root cause (tagged)\n‚Ä¢ Agentic issue flag: YES/NO", shape=box, fillcolor="#FFC0CB"];
    }

    // Decision Logic
    subgraph cluster_logic {
        label="Routing Logic";
        style=filled;
        fillcolor="#F5F5F5";
        
        DECISION [label="Check:\nAgentic issues present?", shape=diamond, fillcolor="#FFFFCC"];
    }

    // Agent 3
    subgraph cluster_agent3 {
        label="AGENT 3: Suggest Workflow Improvements\n(ONLY if agentic issues found)";
        style=filled;
        fillcolor="#E8FFE8";
        
        AGENT3 [label="For calls with agentic issues:\n\nPrompt: \"How can we improve\nthe agent workflow?\"\n\n‚úÖ Output 3 (conditional):\n‚Ä¢ Issue identified\n‚Ä¢ Root cause analysis\n‚Ä¢ Suggested fixes\n‚Ä¢ New workflow steps\n‚Ä¢ Improved prompt\n‚Ä¢ API call corrections", shape=box, fillcolor="#50C878"];
    }

    // ============================================================================
    // LAYER 5: RESPONSE FORMATTER
    // ============================================================================
    subgraph cluster_response {
        label="LAYER 5: Generic Response Formatter\n(Enterprise-grade)";
        style=filled;
        fillcolor="#F0F0F0";
        
        FORMATTER [label="Response Builder\n\nCombine all outputs into\ngeneric JSON format", shape=box, fillcolor="#D3D3D3"];
    }

    // ============================================================================
    // LAYER 6: OUTPUT
    // ============================================================================
    subgraph cluster_output {
        label="LAYER 6: Output - Generic Response JSON";
        style=filled;
        fillcolor="#E8FFE8";
        
        OUTPUT [label="Generic JSON Response\n(handles all agent types)\n\n{\n  \"responseType\": \"call_analysis\",\n  \"batchId\": \"batch_20260217_001\",\n  \"callsAnalyzed\": 10,\n  \"analysisResults\": [\n    {\n      \"callId\": \"call_001\",\n      \"conversationJson\": {...},\n      \"apiCalls\": [...],\n      \"output1_purpose\": {\n        \"purpose\": \"appointment_booking\",\n        \"confidence\": \"high\",\n        \"summary\": \"...\"\n      },\n      \"output2_failureAnalysis\": {\n        \"operationalIssues\": [...],\n        \"agenticIssues\": [...],\n        \"hasAgenticIssues\": true\n      },\n      \"output3_improvements\": {\n        \"issue\": \"...\",\n        \"fixes\": [...],\n        \"newWorkflow\": [...]\n      }\n    },\n    ...(9 more calls)\n  ]\n}\n\n‚ú® Future-proof:\n‚Ä¢ Extensible for new agent types\n‚Ä¢ Different responseType values\n‚Ä¢ Backward compatible", shape=box, fillcolor="#50C878"];
    }

    // ============================================================================
    // LAYER 7: DASHBOARD & STORAGE
    // ============================================================================
    subgraph cluster_dashboard {
        label="LAYER 7: Dashboard & Storage\n(for review & action)";
        style=filled;
        fillcolor="#F5F5F5";
        
        DASHBOARD [label="Dashboard Display\n\n‚úì Batch summary\n‚úì Per-call analysis\n‚úì Operational issues\n‚úì Agentic issues\n‚úì Recommended fixes\n‚úì Historical trends", shape=box, fillcolor="#D3D3D3"];
        
        STORAGE [label="Archive Results\n\n‚úì Store response JSON\n‚úì Track improvements\n‚úì Audit trail\n‚úì Analytics", shape=cylinder, fillcolor="#A9A9A9"];
    }

    // ============================================================================
    // DATA FLOWS
    // ============================================================================
    
    // Data source to scheduler
    DB -> CRONJOB [label="Daily trigger", color="blue", penwidth=2];
    
    // Scheduler to filter
    CRONJOB -> FILTER [label="Execute", color="blue", penwidth=2];
    
    // Filter to batch
    FILTER -> BATCH [label="Filtered calls\n(with issues only)", color="blue", penwidth=2];
    
    // Batch processing
    BATCH -> QUEUE [label="Create batches", color="blue"];
    QUEUE -> AGENT1 [label="Batch of 10 calls\n(as JSON)", color="blue", penwidth=2];
    
    // Agent workflow
    AGENT1 -> AGENT2A [label="Output 1 +\nfull data", color="blue", penwidth=2];
    
    AGENT2A -> AGENT2B [label="Analyze", color="orange"];
    AGENT2A -> AGENT2C [label="Analyze", color="red"];
    
    AGENT2B -> AGENT2_OUT;
    AGENT2C -> AGENT2_OUT;
    
    AGENT2_OUT -> DECISION [label="Output 2", color="blue", penwidth=2];
    
    // Conditional routing
    DECISION -> AGENT3 [label="YES: agentic issues\nfound", color="red", penwidth=2, style=dashed];
    DECISION -> FORMATTER [label="NO: only operational\nissues", color="green", penwidth=2, style=dashed];
    
    // Agent 3 to formatter
    AGENT3 -> FORMATTER [label="Output 3", color="green", penwidth=2];
    
    // Formatter to output
    FORMATTER -> OUTPUT [label="Build generic JSON", color="blue", penwidth=2];
    
    // Output to dashboard
    OUTPUT -> DASHBOARD [label="Display results", color="green", penwidth=2];
    OUTPUT -> STORAGE [label="Archive", color="green", penwidth=2];

    // ============================================================================
    // CALL JSON STRUCTURE (INFO BOX)
    // ============================================================================
    subgraph cluster_call_json {
        label="Call JSON Structure\n(from database)";
        style=filled;
        fillcolor="#FFFACD";
        
        CALL_STRUCTURE [label="{\n  \"callId\": \"call_001\",\n  \"timestamp\": \"2026-02-17T14:30:00Z\",\n  \"patientId\": \"pat_001\",\n  \"conversation\": [\n    {\"role\": \"patient\", \"content\": \"...\"},\n    {\"role\": \"agent\", \"content\": \"...\"}\n  ],\n  \"customApiCalls\": [\n    {\n      \"name\": \"searchPatient\",\n      \"params\": {...},\n      \"response\": {...}\n    },\n    {\n      \"name\": \"findSlots\",\n      \"params\": {...},\n      \"response\": {...}\n    },\n    {\n      \"name\": \"bookAppointment\",\n      \"status\": \"failed\",\n      \"error\": \"No slots available\"\n    }\n  ]\n}", shape=box, fillcolor="white"];
    }

    // ============================================================================
    // KEY METRICS & SLA
    // ============================================================================
    subgraph cluster_metrics {
        label="Performance & SLA";
        style=filled;
        fillcolor="#F5F5F5";
        
        M1 [label="‚è±Ô∏è Processing: ~10-15 min/batch", shape=note, fillcolor="lightyellow"];
        M2 [label="üìä Batch Size: 10 calls/batch", shape=note, fillcolor="lightyellow"];
        M3 [label="üîÑ Frequency: Daily (23:59 PM)", shape=note, fillcolor="lightyellow"];
        M4 [label="üíæ Retention: Results archived for audit", shape=note, fillcolor="lightyellow"];
    }

}
